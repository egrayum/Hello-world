<html>
 <head>
  <title>turtlekins game</title>
  <link rel="stylesheet" type="text/css" href="labs.css"></link>
  <canvas id="gameCanvas" style="background-color: #666; width:100%; height:100%; text-align:center;">
  <script>
   var c = document.getElementById("gameCanvas");
   var ctx = c.getContext("2d");
   var pX = 100;
   var pY = 100;
   var direct;
   var click;
   var screen = 1;
   var coins = 0;
   var room;
   var oldpX;
   var oldpY;
   var layout = [];
   var roomPos;
   var posChangeX;
   var posChangeY;
   var posStore = [];
   var i;
   var direction;
   var found;
   var nType = [1, 2, 4, 5, 7, 8, 11];
   var sType = [1, 2, 4, 6, 9, 10, 11];
   var eType = [3, 4, 5, 6, 8, 10, 11];
   var wType = [2, 3, 5, 6, 7, 9, 11];
   function checkSecret() {
    room = layout[i].type;
    if (direction == "N") {
     if (room == 3 || room == 6 || room == 9 || room == 10) {
      room = 99;
     }
    } else if (direction == "S") {
     if (room == 3 || room == 5 || room == 7 || room == 8) {
      room = 100;
     }
    } else if (direction == "E") {
     if (room == 1 || room == 7 || room == 2 || room == 9) {
      room = 101;   
     }
    } else if (direction == "W") {
     if (room == 1 || room == 4 || room == 8 || room == 10) {
      room = 102;
     }
    }
    found = 2;
   }
   function collision(ifs) {
    if (ifs) {
       pX = oldpX;
       pY = oldpY;
      } else { 
       oldpX = pX;
       oldpY = pY;
      }
   }
   function init() {
    c.width = 800;
    c.height = 600;
    ctx.fillStyle = "#111";
    ctx.font = "20px Arial";
    ctx.fillText("Press space or click to start", 250, 320);
    click = 1;
   }
   c.onmousedown = function clickStuff() {
    if (click == 1) {
     click = undefined;
     window.setInterval(runGame, 20);
    }
   }
   document.addEventListener("keyup", function(event) {
    if (event.keyCode == 37 || event.keyCode == 38 || event.keyCode == 39 || event.keyCode == 40) {
     direct = undefined; 
    }
   })
   document.addEventListener("keydown", function(event) {
    if (event.keyCode == 37) {
     direct = 1;
    } else if (event.keyCode == 38) {
     direct = 2; 
    } else if (event.keyCode == 39) {
     direct = 3;
    } else if (event.keyCode == 40) {
     direct = 4;
    } else if (event.keyCode == 32 && click == 1) {
     click = undefined;
     window.setInterval(runGame, 20);
    }
   })
   function runGame() {
    ctx.fillStyle = "#666";
    ctx.fillRect(0, 0, c.width, c.height);
    // above ground
    if (screen == 1) {
     ctx.fillStyle = "#DEB887";
     ctx.fillRect(250, 20, 300, 200);
     ctx.fillStyle = "#333";
     ctx.font = "35px Arial";
     ctx.fillText("Shop", 260, 55);
     ctx.fillStyle = "#000";
     ctx.fillRect(600, 400, 180, 180);
     ctx.fillText("Mine", 620, 380);
     if (pX > 560 && pY > 360) {
      screen = 2;
      room = 11;
      roomPos = "1,1";
      pX = 375;
      pY = 275;
      layout[0] = {
       "type":11,
       "pos":"1,1"
      }
     }
    } else if (screen == 2) {
     ctx.fillStyle = "#333";
     if (room == 1) {
      // I
      ctx.fillRect(0, 0, 300, c.height);
      ctx.fillRect(500, 0, 300, c.height);
      collision(pX < 300 || pX > 450);
     } else if (room == 2) {
      // T from the left
      ctx.fillRect(0, 0, 300, c.height); 
      ctx.fillRect(500, 0, 300, 200);
      ctx.fillRect(500, 400, 300, 200);
      collision(pX < 300 || pX > 450 && pY < 200 || pX > 450 && pY > 350);
     } else if (room == 3) { 
      // I on its side
      ctx.fillRect(0, 0, c.width, 200);
      ctx.fillRect(0, 400, c.width, 200);
      collision(pY < 200 || pY > 350);
     } else if (room == 4) {
      // T from the right
      ctx.fillRect(0, 0, 300, 200);
      ctx.fillRect(500, 0, 300, c.height);
      ctx.fillRect(0, 400, 300, 200);
      collision(pX > 450 || pX < 300 && pY > 350 || pX < 300 && pY < 200);
     } else if (room == 5) {
      // T
      ctx.fillRect(0, 0, c.width, 200);
      ctx.fillRect(500, 400, 300, 200);
      ctx.fillRect(0, 400, 300, 200);
      collision(pY < 400 || pY > 350 && pX < 300 || pY > 350 && pX > 450);
     } else if (room == 6) {
      // upside-down T
      ctx.fillRect(0, 400, c.width, 200);
      ctx.fillRect(0, 0, 300, 200);
      ctx.fillRect(500, 0, 300, 200);
      collision(pY > 350 || pY < 200 && pX < 300 || pY < 200 && pX > 450);
     } else if (room == 7) {
      // Upside-down L
      ctx.fillRect(0, 0, c.width, 200);
      ctx.fillRect(0, 0, 300, c.height);
      ctx.fillRect(500, 400, 300, 200);
      collision(pX < 300 || pY < 200 || pX > 450 && pY > 350);
     } else if (room == 8) {
      // Rotated L
      ctx.fillRect(0, 0, c.width, 200);
      ctx.fillRect(500, 0, 300, c.height);
      ctx.fillRect(0, 400, 300, 200);
      collision(pY < 200 || pX > 450 || pY > 350 && pX < 300);
     } else if (room == 9) {
      // L
      ctx.fillRect(0, 0, 300, c.height);
      ctx.fillRect(0, 400, c.width, 200);
      ctx.fillRect(500, 0, 300, 200);
      collision(pX < 300 || pY > 350 || pX > 450 && pY < 200);
     } else if (room == 10) {
      // Reflected L
      ctx.fillRect(0, 0, 300, 200);
      ctx.fillRect(0, 400, c.width, 200);
      ctx.fillRect(500, 0, 300, c.height);
      collision(pX > 450 || pY > 350 || pY < 200 && pX < 300);
     } else if (room == 11) { 
      // Plus
      ctx.fillRect(0, 0, 300, 200);
      ctx.fillRect(500, 0, 300, 200);
      ctx.fillRect(500, 400, 300, 200);
      ctx.fillRect(0, 400, 300, 200);
      collision(pX < 300 && pY < 200 || pX > 450 && pY < 200 || pX > 450 && pY > 350 || pX < 300 && pY > 350);
     } else if (room == 99) {
      // secret room enterable going N
      ctx.fillRect(0, 0, c.width, 50);
      ctx.fillRect(0, 0, 50, c.height);
      ctx.fillRect(750, 0, 50, c.height);
      ctx.fillRect(0, 550, 300, 50);
      ctx.fillRect(500, 550, 300, 50);
     } else if (room == 100) {
      // secret room enterable going S
      ctx.fillRect(0, 0, 300, 50);
      ctx.fillRect(0, 0, 50, c.height);
      ctx.fillRect(0, 550, c.width, 50);
      ctx.fillRect(500, 0, 300, 50);
      ctx.fillRect(750, 0, 50, c.height);
     } else if (room == 101) {
      // room enterable going E
      ctx.fillRect(0, 0, c.width, 50);
      ctx.fillRect(750, 0, 50, c.height);
      ctx.fillRect(0, 550, c.width, 50);
      ctx.fillRect(0, 0, 50, 200);
      ctx.fillRect(0, 400, 50, 200);
     } else if (room == 102) {
      // enterable going W
      ctx.fillRect(0, 0, c.width, 50);
      ctx.fillRect(0, 0, 50, c.height);
      ctx.fillRect(0, 550, c.width, 50);
      ctx.fillRect(750, 0, 50, 200);
      ctx.fillRect(750, 400, 50, 200);
     }
     
     if (pX < 5) {
      posStore = roomPos.split(",");
      posChangeX = parseInt(posStore[0], 10);
      posChangeY = posStore[1];
      posChangeX -= 1;
      posChangeX.toString(10);
      roomPos = posChangeX + "," + posChangeY;
      direction = "W";
      checkRoom();
      pX = 745;
     } else if (pX > 745) {
      posStore = roomPos.split(",");
      posChangeX = parseInt(posStore[0], 10);
      posChangeY = posStore[1];
      posChangeX += 1;
      posChangeX.toString(10);
      roomPos = posChangeX + "," + posChangeY;
      direction = "E";
      checkRoom();
      pX = 10;
     } else if (pY < 5) {
      posStore = roomPos.split(",");
      posChangeY = parseInt(posStore[1], 10);
      posChangeX = posStore[0];
      posChangeY += 1;
      posChangeY.toString(10);
      roomPos = posChangeX + "," + posChangeY;
      direction = "N";
      checkRoom();
      pY = 545;
     } else if (pY > 545) {
      posStore = roomPos.split(",");
      posChangeY = parseInt(posStore[1], 10);
      posChangeX = posStore[0];
      posChangeY -= 1;
      posChangeY.toString(10);
      roomPos = posChangeX + "," + posChangeY;
      direction = "S";
      checkRoom();
      pY = 10;
     }
    }
    // check if the room exists
    function checkRoom() {
     found = 1;
     for (i = 0; i < layout.length; i++) {
      if (layout[i].pos == roomPos) {
       room = layout[i].type;
       checkSecret();
      } 
     }
     if (found == 1) {
       addRoom();
      }
    }
    // function that adds a room to the array
    function addRoom () {
     if (direction == "N") {
      room = nType[Math.round(Math.random() * (nType.length - 1))];
      layout[layout.length] = {
       "type":room,
       "pos":roomPos
      }
     } else if (direction == "E") {
      room = eType[Math.round(Math.random() * (eType.length - 1))];
      layout[layout.length] = {
       "type":room,
       "pos":roomPos
      }
     } else if (direction == "W") {
      room = wType[Math.round(Math.random() * (wType.length - 1))];
      layout[layout.length] = {
       "type":room,
       "pos":roomPos
      }
     } else if (direction == "S") {
     room = sType[Math.round(Math.random() * (sType.length - 1))];
      layout[layout.length] = {
       "type":room,
       "pos":roomPos
      }
     }
    }
    // for moving the player
    if (direct == 1 && pX - 5 > - 5) {
     pX -= 5;
    } else if (direct == 2 && pY - 5 > - 5) {
     pY -= 5;
    } else if (direct == 3 && pX + 5 < 755) {
     pX += 5;
    } else if (direct == 4 && pY + 5 < 555) {
     pY += 5;
    }
    //player and stats
    ctx.fillStyle = "#111";
    ctx.fillRect(pX, pY, 50, 50);
    ctx.fillStyle = "#fff";
    ctx.font = "20px Arial";
    ctx.fillText("Coins: " + coins, 10, 25);
    ctx.fillText("Room type: " + room, 10, 75);
    if (room == 99 || room == 100 || room == 101 || room == 102) {
     ctx.fillText("Room position: Unknown", 10, 50);
    } else {
     ctx.fillText("Room position: " + roomPos, 10, 50);
    }
   }
  </script>
 </head>
 <body onload="init()">
 </body>
<html>
